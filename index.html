<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BTC Up/Down — Hybrid</title>
  <style>
    body { background:#0b0b0d; color:#e9eaee; font:400 16px/1.5 ui-sans-serif,system-ui; }
    .wrap{max-width:720px; margin:32px auto; padding:0 16px}
    .title{font-size:28px;font-weight:800;margin-bottom:6px}
    .subtitle{color:#9aa0a6;font-size:14px;margin-bottom:20px}
    .card{background:#141418;border-radius:14px;padding:16px 20px;margin-bottom:12px;
          display:flex;justify-content:space-between;align-items:center}
    .label{color:#9aa0a6;font-size:12px;text-transform:uppercase}
    .value{font-variant-numeric:tabular-nums;font-weight:700;font-size:20px}
    .pos{color:#17c964} .neg{color:#ff3b3b}
    .foot{margin-top:18px;color:#9aa0a6;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">BTC Up/Down — Hybrid</div>
  <div class="subtitle">Live from Binance · Hour window (ET)</div>

  <div class="card"><div class="label">Price</div><div id="price" class="value">—</div></div>
  <div class="card"><div class="label">Price to Beat</div><div id="ptb" class="value">—</div></div>
  <div class="card"><div class="label">Time Left</div><div id="left" class="value">—</div></div>
  <div class="card"><div class="label">Gap to Beat ($)</div><div id="gap" class="value">—</div></div>
  <div class="card"><div class="label">Expected Move ($)</div><div id="em" class="value">—</div></div>
  <div class="card"><div class="label">Strength (%)</div><div id="strength" class="value">—</div></div>
  <div class="card"><div class="label">Up %</div><div id="up" class="value">—</div></div>
  <div class="card"><div class="label">Down %</div><div id="down" class="value">—</div></div>

  <div id="footer" class="foot">Last update: —</div>
</div>

<script>
const SYMBOL = 'BTCUSDT';
const WS_URL = `wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@trade`;
const API = 'https://cors-proxy.fringe.zone/https://api.binance.com/api/v3';

let ws, price=null, priceToBeat=null, sigma1h=null;

function fmt(n,d=2){return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
function setText(id,txt,cls){let el=document.getElementById(id); if(!el)return;
  el.classList.remove('pos','neg'); if(cls)el.classList.add(cls); el.textContent=txt;}
function getParts(date,tz){return new Intl.DateTimeFormat('en-US',{timeZone:tz,hour12:false,
  year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).formatToParts(date);}
function tzOffsetMs(tz){const now=new Date(); const pET=getParts(now,tz), pUTC=getParts(now,'UTC');
  const asET=Date.UTC(pET[4].value,pET[0].value-1,pET[2].value,pET[6].value,pET[8].value,pET[10].value);
  const asUTC=Date.UTC(pUTC[4].value,pUTC[0].value-1,pUTC[2].value,pUTC[6].value,pUTC[8].value,pUTC[10].value);
  return asUTC-asET;}
function startOfETHourUTC(){const p=getParts(new Date(),'America/New_York');const off=tzOffsetMs('America/New_York');
  return Date.UTC(p[4].value,p[0].value-1,p[2].value,p[6].value,0,0)+off;}
function secondsLeftInETHour(){const p=getParts(new Date(),'America/New_York');
  return (59-p[8].value)*60+(60-p[10].value);}
function erf(x){const s=Math.sign(x);x=Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t=1/(1+p*x);const y=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);return s*y;}
const cdf=x=>0.5*(1+erf(x/Math.SQRT2));

async function loadPriceToBeat(){
  try{
    const start=startOfETHourUTC();const end=start+60000;
    const res=await fetch(`${API}/klines?symbol=${SYMBOL}&interval=1m&startTime=${start}&endTime=${end}&limit=1`);
    const arr=await res.json(); if(arr.length){priceToBeat=parseFloat(arr[0][1]);setText('ptb',fmt(priceToBeat));}
  }catch(e){console.error("PTB error",e);}
}

// حساب التذبذب من آخر 60 شمعة (realized vol)
async function loadVolatility(){
  try{
    const res=await fetch(`${API}/klines?symbol=${SYMBOL}&interval=1m&limit=60`);
    const kl=await res.json(); if(!Array.isArray(kl)||kl.length<2)return;
    const closes=kl.map(k=>+k[4]); let rets=[];
    for(let i=1;i<closes.length;i++){rets.push(Math.log(closes[i]/closes[i-1]));}
    const mean=rets.reduce((a,b)=>a+b,0)/rets.length;
    const variance=rets.reduce((a,b)=>a+(b-mean)**2,0)/(rets.length-1);
    const sigma1m=Math.sqrt(variance); 
    sigma1h = sigma1m*Math.sqrt(60); // تقلب ساعة كاملة
  }catch(e){console.error("Vol error",e);}
}

function connectWS(){
  if(ws) try{ws.close();}catch{}; ws=new WebSocket(WS_URL);
  ws.onmessage=(ev)=>{const d=JSON.parse(ev.data); price=parseFloat(d.p);
    setText('price',fmt(price)); updateDerived(); setFooter();};
  ws.onclose=()=>setTimeout(connectWS,1500);
}

function updateDerived(){
  if(price==null||priceToBeat==null||sigma1h==null)return;
  const gap=price-priceToBeat;
  setText('gap',(gap>=0?'+':'')+fmt(gap),gap>=0?'pos':'neg');

  // Black–Scholes Expected Move (حسب الوقت المتبقي)
  const secs=secondsLeftInETHour();
  const frac=secs/3600; // جزء الساعة المتبقي
  const bsMove=price*sigma1h*Math.sqrt(frac);
  setText('em',fmt(bsMove,2));

  // Strength (عكسي: gap قريب = قوي)
  const strength=100-Math.min(Math.abs(gap)/bsMove*100,100);
  setText('strength',fmt(strength,1));

  // احتمالية Up/Down
  const z=(-gap)/(bsMove+1e-9);
  const up=cdf(z)*100, down=100-up;
  setText('up',fmt(up,1),'pos'); 
  setText('down',fmt(down,1),'neg');
}

function tick(){
  const s=secondsLeftInETHour();
  setText('left',String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0'));
  updateDerived();
}

function setFooter(){document.getElementById('footer').textContent=
  "Last update: "+new Date().toISOString().replace("T"," ").replace("Z"," UTC")+" · WebSocket: Binance · TZ: America/New_York (ET)";}

async function init(){
  connectWS(); await loadPriceToBeat(); await loadVolatility();
  setInterval(loadVolatility,60000); // تحديث التذبذب كل دقيقة
  setInterval(tick,1000);
}
init();
</script>
</body>
</html>
