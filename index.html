<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f1a"/>
  <title>Crypto Up/Down — PWA</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b0f1a; --card:#121826; --ink:#e7eaf0; --muted:#97a1b3;
      --pos:#22c55e; --neg:#ef4444; --accent:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(22px,4vw,40px);letter-spacing:.3px;margin:8px 0 2px}
    .sub{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:var(--card);border-radius:14px;padding:14px 16px}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .sym{font-weight:800;letter-spacing:.8px}
    .price{font-variant-numeric:tabular-nums}
    .row{display:flex;justify-content:space-between;margin:8px 0}
    .lbl{color:var(--muted);font-size:13px}
    .val{font-variant-numeric:tabular-nums;font-weight:700}
    progress{width:100%;height:10px;border:0;border-radius:999px;background:#0f1526}
    progress::-webkit-progress-bar{background:#0f1526;border-radius:999px}
    progress::-webkit-progress-value{background:var(--accent);border-radius:999px}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    .foot{color:var(--muted);font-size:12px;margin-top:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Crypto Up/Down — PWA</h1>
    <div class="sub">BTCUSDT · ETHUSDT · SOLUSDT · XRPUSDT — Live via Binance WebSocket</div>

    <div id="grid" class="grid"></div>

    <div class="foot" id="status">Preparing…</div>
  </div>

<script>
// ====== Config ======
const PAIRS = ["btcusdt","ethusdt","solusdt","xrpusdt"];
const Z_SCALE = 0.9;

// ====== Utilities ======
const fmt = (n, d=2)=> isFinite(n) ? Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}) : "—";
const clamp=(x,a,b)=> Math.max(a,Math.min(b,x));
function normCDF(x){ // Abramowitz–Stegun (no Math.erf required)
  const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429, p=0.3275911;
  const sign = x<0?-1:1, z = Math.abs(x)/Math.sqrt(2), t = 1/(1+p*z);
  const y = 1-(((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t)*Math.exp(-z*z);
  return 0.5*(1+sign*y);
}

// ====== DOM Setup ======
const grid = document.getElementById("grid");
const cards = {};
PAIRS.forEach(sym=>{
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <div class="hdr"><div class="sym">${sym.toUpperCase()}</div><div id="${sym}-price" class="price">—</div></div>
    <div class="row"><div class="lbl">UP %</div><div id="${sym}-up" class="val">—</div></div>
    <progress id="${sym}-prog" value="50" max="100"></progress>
    <div class="row"><div class="lbl">DOWN %</div><div id="${sym}-down" class="val">—</div></div>
    <div class="row"><div class="lbl">GAP</div><div id="${sym}-gap" class="val">—</div></div>
    <div class="row"><div class="lbl">EM</div><div id="${sym}-em" class="val">—</div></div>
  `;
  grid.appendChild(card);
  cards[sym] = {
    price: document.getElementById(`${sym}-price`),
    up: document.getElementById(`${sym}-up`),
    down: document.getElementById(`${sym}-down`),
    prog: document.getElementById(`${sym}-prog`),
    gap: document.getElementById(`${sym}-gap`),
    em: document.getElementById(`${sym}-em`),
  };
});

// ====== Combined Stream ======
const stream = "wss://stream.binance.com:9443/stream?streams=" + PAIRS.map(s=>`${s}@ticker`).join("/");
let lastStatus = "";
function setStatus(msg){
  if(msg!==lastStatus){ document.getElementById("status").textContent = msg; lastStatus = msg; }
}

const ws = new WebSocket(stream);
ws.onopen = ()=> setStatus("Connected");
ws.onclose = ()=> setStatus("Disconnected — retry soon");
ws.onerror = ()=> setStatus("Error — reconnecting…");

ws.onmessage = (ev)=>{
  const wrap = JSON.parse(ev.data);
  const d = wrap.data;
  const sym = d.s.toLowerCase();       // symbol
  if(!cards[sym]) return;

  const price = parseFloat(d.c);
  const high  = parseFloat(d.h);
  const low   = parseFloat(d.l);

  // Mid of 24h range
  const mid = (high + low) / 2;
  const gap = price - mid;

  // Parkinson-like EM from 24h high/low (quick, stable)
  const ln2 = Math.log(2);
  const em_raw = (high>0 && low>0) ? ( (high - low) / Math.sqrt(4*ln2) ) : 0;
  const em = Math.max(em_raw, Math.max(1e-6, price*1e-6)); // numerical floor

  // Probabilities (Poly-like): UP=Φ(z), z = gap/EM
  const z = clamp((gap / em) * Z_SCALE, -8, 8);
  const up = clamp(normCDF(z), 0, 1) * 100;
  const down = 100 - up;

  // Render
  cards[sym].price.textContent = fmt(price, 2);
  cards[sym].gap.textContent   = (gap>=0?"+":"") + fmt(gap, 2);
  cards[sym].gap.className = "val " + (gap>=0?"pos":"neg");
  cards[sym].em.textContent    = fmt(em, 2);
  cards[sym].up.textContent    = fmt(up, 1) + "%";
  cards[sym].down.textContent  = fmt(down, 1) + "%";
  cards[sym].prog.value = up;
};

// ====== PWA: register service worker ======
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
