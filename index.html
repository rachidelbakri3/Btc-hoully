<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BTC Up/Down — Hybrid</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{
    --bg:#0b0f1a; --card:#121826; --ink:#e7eaf0; --muted:#97a1b3;
    --pos:#22c55e; --neg:#ef4444; --accent:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:900px;margin:28px auto;padding:0 16px}
  h1{font-size:clamp(24px,4vw,44px);letter-spacing:.5px;margin:8px 0 6px}
  .sub{color:var(--muted);margin-bottom:22px}
  .grid{display:grid;gap:14px}
  .row{background:var(--card);border-radius:16px;padding:18px 20px;display:flex;justify-content:space-between;align-items:center}
  .lbl{color:var(--muted);font-weight:600;letter-spacing:.6px}
  .val{font-variant-numeric:tabular-nums; font-size:clamp(18px,3.4vw,28px); font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .foot{color:var(--muted);font-size:12px;margin-top:18px;line-height:1.5}
  .opts label{font-size:14px; font-weight:600; color:var(--ink);}
  .opts input{transform: translateY(1px);}
</style>
</head>
<body>
  <div class="wrap">
    <h1>BTC Up/Down — Hybrid</h1>
    <div class="sub">Live from Binance · Hour window (ET)</div>

    <div class="grid">
      <div class="row"><div class="lbl">PRICE</div>            <div id="priceVal"    class="val mono">—</div></div>
      <div class="row"><div class="lbl">PRICE TO BEAT</div>     <div id="ptbVal"      class="val mono">—</div></div>
      <div class="row"><div class="lbl">TIME LEFT</div>         <div id="timeLeftVal" class="val mono">—</div></div>
      <div class="row"><div class="lbl">GAP TO BEAT ($)</div>   <div id="gapVal"      class="val mono">—</div></div>
      <div class="row"><div class="lbl">EXPECTED MOVE ($)</div> <div id="emVal"       class="val mono">—</div></div>
      <div class="row"><div class="lbl">STRENGTH (%)</div>      <div id="strVal"      class="val mono">—</div></div>
      <div class="row"><div class="lbl">UP %</div>              <div id="upVal"       class="val mono">—</div></div>
      <div class="row"><div class="lbl">DOWN %</div>            <div id="downVal"     class="val mono">—</div></div>
      <!-- مفتاح التبديل -->
      <div class="row">
        <div class="lbl">PROB MODE</div>
        <div class="val mono opts">
          <label><input type="radio" name="mode" value="poly" checked> Poly-like</label>
          <label style="margin-inline-start:14px;"><input type="radio" name="mode" value="bs"> Black–Scholes d2</label>
        </div>
      </div>
    </div>

    <div class="foot" id="footNote">Connecting…</div>
    <div class="foot">WebSocket: Binance · REST: 1m/1h (klines) · TZ: America/New_York (ET)</div>
  </div>

<script>
/* ========= Utilities ========= */
const {DateTime} = luxon;
const TZ = "America/New_York";
const SYM = "BTCUSDT";
const WS_URL = "wss://stream.binance.com:9443/ws/btcusdt@trade";
const REST = "https://api.binance.com/api/v3";

const fmtUSD = x => (isFinite(x) ? Number(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : "—");
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
function setText(id, text, colorClass=null){
  const el = document.getElementById(id);
  el.textContent = text;
  el.classList.remove("pos","neg");
  if(colorClass) el.classList.add(colorClass);
}
function signClass(n){ if(!isFinite(n)) return null; return n>=0 ? "pos":"neg"; }
function nowET(){ return DateTime.now().setZone(TZ); }

/* Normal CDF (Abramowitz–Stegun, بدون Math.erf) */
function normCDF(x){
  const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429;
  const p=0.3275911;
  const sign = x < 0 ? -1 : 1;
  const z = Math.abs(x) / Math.sqrt(2);
  const t = 1 / (1 + p*z);
  const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-z*z);
  return 0.5 * (1 + sign*y);
}

/* ========= State ========= */
let S = NaN;      // live price
let PTB = NaN;    // price to beat (open at start of ET hour)
let gap = NaN;    // S - PTB
let minutesLeft = 0;
let sigma_pm = NaN; // per-minute volatility (EWMA of 1m returns)
let EM = NaN;     // expected move ($)
let ws = null;
let lastFoot = "";
let probMode = "poly"; // "poly" أو "bs"

/* ========= Time Window (ET hour) ========= */
function getHourWindowET(){
  const now = nowET();
  const start = now.startOf("hour");
  const end   = start.plus({hours:1});
  const msToEnd = end.toMillis() - now.toMillis();
  const mins = Math.max(0, msToEnd/60000);
  return {start, end, minutesLeft: mins};
}
function renderTimeLeft(){
  const {end} = getHourWindowET();
  const diff = end.diff(nowET(), ["minutes","seconds"]);
  const mm = String(Math.max(0, Math.floor(diff.minutes))).padStart(2,"0");
  const ss = String(Math.max(0, Math.floor(diff.seconds))).padStart(2,"0");
  setText("timeLeftVal", `${mm}:${ss}`);
}

/* ========= Fetch Price To Beat (start of ET hour) ========= */
async function fetchPTB(){
  const {start} = getHourWindowET();
  const startUTCms = start.toUTC().toMillis();
  let open = null;
  try{
    const res = await fetch(`${REST}/klines?symbol=${SYM}&interval=1m&startTime=${startUTCms}&limit=1`);
    const data = await res.json();
    if(Array.isArray(data) && data.length) open = parseFloat(data[0][1]); // 'o'
  }catch(e){}
  if(!isFinite(open)){
    try{
      const r2 = await fetch(`${REST}/klines?symbol=${SYM}&interval=1h&limit=1`);
      const d2 = await r2.json();
      if(Array.isArray(d2) && d2.length) open = parseFloat(d2[0][1]);
    }catch(e){}
  }
  PTB = open;
  setText("ptbVal", isFinite(PTB)? fmtUSD(PTB) : "—");
}

/* ========= Realized Vol (EWMA, 1m) ========= */
async function fetchSigmaPerMinute(){
  try{
    const res = await fetch(`${REST}/klines?symbol=${SYM}&interval=1m&limit=500`);
    const kl = await res.json();
    if(!Array.isArray(kl) || kl.length < 30) return;

    const closes = kl.map(row => parseFloat(row[4]));
    const rets = [];
    for(let i=1;i<closes.length;i++){
      const r = Math.log(closes[i] / closes[i-1]);
      if(isFinite(r)) rets.push(r);
    }

    const lambda = 0.96; // حساسية آخر الدقائق
    let v = rets.length ? rets[0]*rets[0] : 0;
    for(let i=1;i<rets.length;i++){
      v = lambda * v + (1-lambda) * (rets[i]*rets[i]);
    }
    sigma_pm = Math.sqrt(Math.max(v,0));
    renderAll(); // تحديث فوري بعد وصول σ
  }catch(e){}
}

/* ========= Expected Move ========= */
function computeEM(){
  const {minutesLeft: mLeft} = getHourWindowET();
  minutesLeft = mLeft;
  if(!isFinite(S) || !isFinite(sigma_pm) || mLeft<=0){ EM = NaN; return; }
  const sigRootT = sigma_pm * Math.sqrt(mLeft); // σ√T (T بالدقائق)
  EM = S * sigRootT; // بالدولار
}

/* ========= UP/DOWN ========= */
/* وضع 1: Poly-like  => z = gap/EM  → UP=Φ(z)
   وضع 2: Black–Scholes d2 */
function computeUpDown(){
  if(probMode === "poly"){
    if(!isFinite(EM) || EM<=1e-9 || !isFinite(gap)) return {up:null, down:null};
    const z = gap / EM;                         // gap موجب ⇒ ميل للـ UP
    const upProb = clamp(normCDF(z), 0, 1);
    return { up: upProb*100, down: (1 - upProb)*100 };
  }else{
    if(!isFinite(S) || !isFinite(PTB) || !isFinite(sigma_pm) || minutesLeft<=0)
      return {up:null, down:null};
    const T = Math.max(minutesLeft, 1e-9);      // دقائق
    const sig = Math.max(sigma_pm, 1e-9);       // لكل دقيقة
    const sigSqrtT = sig * Math.sqrt(T);
    const d2 = (Math.log(S/PTB) - 0.5*sig*sig*T) / sigSqrtT;
    const upProb = clamp(normCDF(d2), 0, 1);
    return { up: upProb*100, down: (1 - upProb)*100 };
  }
}

/* ========= Strength (0..100) — كما هو ========= */
function computeStrength(){
  if(!isFinite(EM) || EM<=0 || !isFinite(gap)) return NaN;
  const ratio = Math.abs(gap) / EM;   // 0 => gap صغير جدًا
  const s = 50 + 50 * (1 - ratio);    // 100% عند gap=0، 50% عند |gap|=EM
  return clamp(s, 0, 100);
}

/* ========= Render ========= */
function renderAll(){
  setText("priceVal", isFinite(S)? fmtUSD(S) : "—");
  renderTimeLeft();

  gap = (isFinite(S) && isFinite(PTB)) ? (S - PTB) : NaN;
  setText("gapVal", isFinite(gap)? (gap>=0? `+${fmtUSD(gap)}` : fmtUSD(gap)) : "—", signClass(gap));

  computeEM();
  setText("emVal", isFinite(EM)? fmtUSD(EM) : "—");

  const strength = computeStrength();
  setText("strVal", isFinite(strength)? strength.toFixed(1)+"%" : "—",
          isFinite(strength) ? (strength>=50? "pos":"neg") : null);

  const {up,down} = computeUpDown();
  setText("upVal",   isFinite(up)?   up.toFixed(1)+"%"   : "—", isFinite(up)   ? (up>=50?"pos":"neg") : null);
  setText("downVal", isFinite(down)? down.toFixed(1)+"%" : "—", isFinite(down) ? (down>=50?"neg":"pos") : null);

  const ts = DateTime.now().toUTC().toFormat("yyyy-LL-dd HH:mm:ss");
  const foot = `Last update: ${ts} UTC`;
  if(foot !== lastFoot){
    document.getElementById("footNote").textContent = foot;
    lastFoot = foot;
  }
}

/* ========= Live Price (WebSocket) ========= */
function startWS(){
  if(ws) try{ ws.close(); }catch(_){}
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=>{ setText("footNote","Connected"); };
  ws.onmessage = (ev)=>{
    const d = JSON.parse(ev.data);
    const p = parseFloat(d.p);
    if(isFinite(p)){
      S = p;
      renderAll();
    }
  };
  ws.onclose = ()=>{ setText("footNote","Disconnected — reconnecting…"); setTimeout(startWS, 1500); };
  ws.onerror = ()=>{ try{ws.close();}catch(_){} };
}

/* ========= Boot ========= */
async function boot(){
  await fetchPTB();
  await fetchSigmaPerMinute();
  startWS();
  renderAll();

  setInterval(fetchSigmaPerMinute, 60_000); // حدّث σ كل دقيقة
  setInterval(async ()=>{
    const t = nowET();
    if(t.minute===0 && t.second<3){ await fetchPTB(); }
  }, 2_000);
  setInterval(renderAll, 1000); // توقيت متبقّي
}
boot();

/* ========= UI: تبديل الوضع ========= */
document.addEventListener("change", (e)=>{
  if(e.target && e.target.name === "mode"){
    probMode = e.target.value; // "poly" أو "bs"
    renderAll();
  }
});
</script>
</body>
</html>
